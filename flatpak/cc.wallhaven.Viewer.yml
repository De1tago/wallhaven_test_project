app-id: cc.wallhaven.Viewer
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
command: python3 -m wallhaven_viewer
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --filesystem=home
  - --talk-name=org.freedesktop.portal.Desktop
  - --metadata=X-DPI-Scale=1
  - --filesystem=xdg-run/dconf
  - --filesystem=~/.config/dconf:ro
  - --talk-name=ca.desrt.dconf
  - --env=DCONF_USER_CONFIG_DIR=.config/dconf
  - --talk-name=org.freedesktop.portal.Wallpaper
  - --talk-name=org.freedesktop.impl.portal.Wallpaper
modules:
  - name: python3-requests
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
        - pip3 install --prefix=/app requests dbus-python PyGObject
    sources:
      - type: shell
        commands:
          - mkdir -p /app/lib/wallhaven-viewer
          - mkdir -p /app/bin
  - name: wallhaven-viewer
    buildsystem: simple
    build-commands:
      # 1. Создаём дерево папок в /app
      - mkdir -p /app/lib/wallhaven-viewer
      - mkdir -p /app/bin
      - mkdir -p /app/share/applications
      - mkdir -p /app/share/icons/hicolor/256x256/apps
      - mkdir -p /app/share/wallhaven_viewer/{css,ui}
      # 2. Копируем Python-пакет
      - cp -r src/wallhaven_viewer/* /app/lib/wallhaven-viewer/
      # 3. Копируем ресурсы (UI/CSS)
      - install -m 644 data/ui/*.ui /app/share/wallhaven_viewer/ui/
      - install -m 644 data/css/*.css /app/share/wallhaven_viewer/css/
      # 4. Устанавливаем .desktop и иконку
      - install -m 644 data/applications/cc.wallhaven.Viewer.desktop /app/share/applications/
      - install -m 644 data/icons/hicolor/256x256/apps/cc.wallhaven.Viewer.png /app/share/icons/hicolor/256x256/apps/
      # 5. Устанавливаем wrapper-скрипт (не нужен, т.к. command уже python3 -m)
      # (оставьте, если хотите fallback)
      # 6. Убедимся, что пакет исполняемый
      - chmod +x /app/lib/wallhaven-viewer/__main__.py
    sources:
      - type: dir
        path: .